<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Ù¾Ø±ØªØ§Ù„ Ù…Ø¯Ø§Ø±Ø³</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: "Vazir", sans-serif;
    }
    .sidebar {
      background-color: #1f1f1f;
      min-height: 100vh;
      padding: 20px;
    }
    .sidebar a {
      color: #e9ffff;
      display: block;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #333;
      color: #65d9d9;
    }
    .card {
      background-color: #1f1f1f;
      border: none;
      color: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      padding: 20px;
      margin-bottom: 25px;
    }
    .navbar {
      background-color: #1f1f1f !important;
      border-radius: 12px;
      padding: 10px;
    }
    #calendar table {
    width: 100%;
    border-collapse: collapse;
  }
  #calendar td {
    width: 40px;
    height: 40px;
    text-align: center;
    vertical-align: middle;
    border-radius: 50%;
    transition: all 0.2s;
    cursor: pointer;
    background-color: #1f1f1f; /* Ø±Ù†Ú¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø³Ù„ÙˆÙ„ */
    color: white;
  }
  #calendar td:hover {
    transform: scale(1.1);
    background-color: #333;
  }
  
  .bg-holiday { background-color: #e53935 !important; color: white; }
  .bg-event { background-color: #2196f3 !important; color: white; position: relative; }
  .bg-today { border: 5px solid #4cacaf !important; }
  .event-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: #fff;
    color: #2196f3;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  #calendar-title {
    font-weight: bold;
    font-size: 1.2rem;
    text-align: center;
  }
  #calendar .btn {
    border-radius: 20px;
  }
  .calendar-card {
    background: linear-gradient(145deg, #1f1f1f, #2c2c2c);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar">
        <h4 class="text-light">Ù…Ù†Ùˆ</h4>
        <a href="{% url 'dashboard' %}">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        <a href="{% url 'subjects' %}">ğŸ“š Ø¯Ø±ÙˆØ³</a>
        <a href="#">ğŸ“ Ù†Ù…Ø±Ø§Øª</a>
        <a href="#">ğŸ“… ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ</a>
        <a href="{% url 'logout' %}">ğŸšª Ø®Ø±ÙˆØ¬</a>
      </nav>

      <!-- Main -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <nav class="navbar navbar-dark">
          <span class="navbar-brand mb-0 h1">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ {{ role }}</span>
        </nav>
        
        <div class="pt-3 pb-2 mb-3">
          <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ {{ request.user.username }}</h2>
        </div>
        <!-- Announcements -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <h4>ğŸ“¢ Ø¢Ø®Ø±ÛŒÙ† Ø§Ø¹Ù„Ø§Ù†Ø§Øª</h4>
      <ul>
        {% for a in announcements %}
          <li><strong>{{ a.title }}</strong> - {{ a.created_at|date:"Y/m/d" }}</li>
          <p>{{ a.content }}</p>
        {% empty %}
          <li>Ø§Ø¹Ù„Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Calendar -->
  <div class="col-md-6">
    <div class="card">
      <h4>ğŸ“… ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ</h4>
        <div class="d-flex justify-content-between mb-2">
          <button class="btn btn-sm btn-outline-light" onclick="prevMonth()">Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
          <h5 id="calendar-title"></h5>
          <button class="btn btn-sm btn-outline-success" onclick="goToToday()">Ø§Ù…Ø±ÙˆØ²</button>
          <button class="btn btn-sm btn-outline-light" onclick="nextMonth()">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯</button>
        </div>
        <div id="calendar" class="table-responsive"></div>
    </div>
  </div>
</div>

        {% if role == "Ù…Ø¯ÛŒØ±" %}
          <div class="row">
            <div class="col-md-3"><div class="card">ğŸ‘¨â€ğŸ“ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†: {{ students_count }}</div></div>
            <div class="col-md-3"><div class="card">ğŸ‘©â€ğŸ« Ù…Ø¹Ù„Ù…ÛŒÙ†: {{ teachers_count }}</div></div>
            <div class="col-md-3"><div class="card">ğŸ“š Ø¯Ø±ÙˆØ³: {{ subjects_count }}</div></div>
            <div class="col-md-3"><div class="card">ğŸ“ Ù†Ù…Ø±Ø§Øª: {{ grades_count }}</div></div>
          </div>
        {% elif role == "Ù…Ø¹Ù„Ù…" %}
          <h4>Ø¯Ø±ÙˆØ³ Ø´Ù…Ø§:</h4>
          <ul>
            {% for s in subjects %}
              <li>{{ s.name }} ({{ s.grades.count }} Ù†Ù…Ø±Ù‡ Ø«Ø¨Øª Ø´Ø¯Ù‡)</li>
            {% empty %}
              <li>Ù‡ÛŒÚ† Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</li>
            {% endfor %}
          </ul>
        {% else %}
          <h4>Ù†Ù…Ø±Ø§Øª Ø´Ù…Ø§:</h4>
          <ul>
            {% for g in grades %}
              <li>{{ g.subject.name }}: {{ g.score }}</li>
            {% empty %}
              <li>Ù‡ÛŒÚ† Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</li>
            {% endfor %}
          </ul>
        {% endif %}
      </main>
    </div>
  </div>

<!--Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ -->
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<script>
  // Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø§Ø² Django (context â†’ JSON)
  const events = JSON.parse('{{ calendar_events_json|safe }}'); 
  // Ù…Ø«Ø§Ù„ Ø´Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:
  // [{date: "1404-06-10", title: "Ø§Ù…ØªØ­Ø§Ù† Ø±ÛŒØ§Ø¶ÛŒ"}, {date: "1404-06-15", title: "ØªØ¹Ø·ÛŒÙ„ Ø±Ø³Ù…ÛŒ"}]

  let current = new Date(); // ØªØ§Ø±ÛŒØ® ÙØ¹Ù„ÛŒ
  let currentYear, currentMonth;

  function renderCalendar() {
    const j = jalaali.toJalaali(current);
    currentYear = j.jy;
    currentMonth = j.jm;

    document.getElementById("calendar-title").innerText = `Ù…Ø§Ù‡ ${currentMonth} Ø³Ø§Ù„ ${currentYear}`;

    let startOfMonth = jalaali.toGregorian(currentYear, currentMonth, 1);
    let firstDay = new Date(startOfMonth.gy, startOfMonth.gm - 1, startOfMonth.gd).getDay();
    let daysInMonth = jalaali.jalaaliMonthLength(currentYear, currentMonth);

    let html = `<table class="table text-center text-light">
  <thead><tr>
    <th>Ø´</th><th>ÛŒ</th><th>Ø¯</th><th>Ø³</th><th>Ú†</th><th>Ù¾</th><th>Ø¬</th>
  </tr></thead><tbody><tr>`;

for (let i = 0; i < firstDay; i++) html += "<td></td>";

for (let d = 1; d <= daysInMonth; d++) {
  const fullDate = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const dayEvents = events.filter(e => e.date === fullDate);

  let classes = "p-2 rounded position-relative";
  let tooltip = dayEvents.length ? dayEvents.map(e => e.title).join(", ") : "Ù…ÙˆØ±Ø¯ÛŒ Ù†ÛŒØ³Øª";

  // ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø¬Ù…Ø¹Ù‡
  let weekday = (firstDay + d - 1) % 7;
  if (weekday === 6) classes += " bg-holiday";

  // Ø§Ù…Ø±ÙˆØ²
  const todayJ = jalaali.toJalaali(new Date());
  if (d === todayJ.jd && currentMonth === todayJ.jm && currentYear === todayJ.jy) classes += " bg-today";

  // Ø±ÙˆÛŒØ¯Ø§Ø¯
  if (dayEvents.length) classes += " bg-event";

  html += `<td class="${classes}" title="${tooltip}">${d}`;
  if (dayEvents.length) html += `<div class="event-badge">${dayEvents.length}</div>`;
  html += `</td>`;

  if ((firstDay + d) % 7 === 0) html += "</tr><tr>";
}

html += "</tr></tbody></table>";
document.getElementById("calendar").innerHTML = html;

  }

  function prevMonth() {
    current.setMonth(current.getMonth() - 1);
    renderCalendar();
  }

  function nextMonth() {
    current.setMonth(current.getMonth() + 1);
    renderCalendar();
  }

  function goToToday() {
      current = new Date();
      renderCalendar();
  }
  renderCalendar();
  
  
</script>
<!-- Ù¾Ø§ÛŒØ§Ù† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ-->
</body>
</html>
